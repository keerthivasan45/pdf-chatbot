<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Tutor Pro | Chat History</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .prose-styles h1, .prose-styles h2, .prose-styles h3 { font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }
        .prose-styles h1 { font-size: 1.5rem; } .prose-styles h2 { font-size: 1.25rem; }
        .prose-styles ul { list-style-type: disc; margin-left: 1.5rem; }
        .prose-styles ol { list-style-type: decimal; margin-left: 1.5rem; }
        .prose-styles p { margin-bottom: 0.75rem; line-height: 1.6; }
        .prose-styles strong { font-weight: 600; }
        .prose-styles code { background-color: #e5e7eb; color: #1f2937; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-family: monospace; }
        .dark .prose-styles code { background-color: #4b5563; color: #e5e7eb; }
        .prose-styles pre { background-color: #1f2937; color: #d1d5db; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
        .dark .prose-styles pre { background-color: #030712; }
        .prose-styles pre code { background-color: transparent; color: inherit; padding: 0; }
        .chat-bubble { max-width: 85%; word-wrap: break-word; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <!-- Authentication View -->
    <div id="auth-view" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg">
            <div>
                <h1 class="text-3xl font-bold text-center text-gray-900 dark:text-white">PDF Tutor Pro</h1>
                <p id="auth-title" class="mt-2 text-center text-sm text-gray-600 dark:text-gray-400">Sign in to your account</p>
            </div>
            <form id="auth-form" class="space-y-6">
                <div>
                    <label for="username" class="text-sm font-medium text-gray-700 dark:text-gray-300">Username</label>
                    <input id="username" name="username" type="text" required class="mt-1 block w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-gray-700 dark:text-gray-300">Password</label>
                    <input id="password" name="password" type="password" required class="mt-1 block w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div id="auth-error" class="text-sm text-red-500 text-center hidden"></div>
                <div>
                    <button id="auth-submit-btn" type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Sign In</button>
                </div>
            </form>
            <p class="text-center text-sm text-gray-500 dark:text-gray-400">
                <a href="#" id="auth-toggle-link" class="font-medium text-indigo-600 hover:text-indigo-500 dark:text-indigo-400">Don't have an account? Register</a>
            </p>
        </div>
    </div>

    <!-- Main Chat Application View (Initially Hidden) -->
    <div id="chat-view" class="hidden h-screen">
        <div class="flex h-full">
            <!-- Sidebar for Chat History -->
            <aside class="w-64 bg-white dark:bg-gray-800 border-r dark:border-gray-700 flex flex-col">
                <div class="p-4 border-b dark:border-gray-700 space-y-4">
                    <h1 class="text-xl text-center font-bold text-gray-900 dark:text-white">PDF Tutor Pro</h1>
                    <button id="new-chat-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">+ New Chat</button>
                </div>
                <nav id="chat-list" class="flex-1 overflow-y-auto p-2 space-y-1"></nav>
                <div class="mt-auto p-4 border-t dark:border-gray-700 space-y-2">
                     <button id="clear-history-btn" class="w-full flex items-center justify-center gap-2 text-sm text-red-600 dark:text-red-400 font-semibold py-2 px-4 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/50 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        <span>Clear History</span>
                    </button>
                     <button id="logout-btn" class="w-full flex items-center justify-center gap-2 text-sm text-gray-600 dark:text-gray-300 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                        <span>Logout</span>
                    </button>
                </div>
            </aside>

            <div class="flex flex-col flex-1">
                <!-- Header -->
                <header class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm border-b border-gray-200 dark:border-gray-700 p-4 flex justify-between items-center sticky top-0 z-10">
                    <h1 id="chat-title" class="text-xl font-bold text-gray-900 dark:text-white">New Chat</h1>
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <svg id="theme-icon-light" class="lucide lucide-sun hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
                        <svg id="theme-icon-dark" class="lucide lucide-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                    </button>
                </header>

                <!-- Chat History -->
                <main id="chat-history" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6"></main>

                <!-- Input Form Area -->
                <footer class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm border-t border-gray-200 dark:border-gray-700 p-4">
                    <div class="max-w-4xl mx-auto">
                        <form id="chat-form" class="space-y-4">
                            <div id="pdf-upload-container" class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:border-indigo-500 dark:hover:border-indigo-400 transition">
                                <label for="pdf-file" class="flex flex-col items-center justify-center space-y-2 w-full h-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-400 dark:text-gray-500"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
                                    <p id="file-name" class="text-sm text-gray-600 dark:text-gray-400">Click or drag & drop a PDF file</p>
                                    <input id="pdf-file" name="pdf_file" type="file" class="sr-only" accept=".pdf">
                                </label>
                            </div>
                            <div class="flex items-center gap-2">
                                <textarea id="question" name="question" rows="1" class="flex-1 p-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none resize-none" placeholder="Ask a question..."></textarea>
                                <button type="submit" id="submit-button" class="bg-indigo-600 text-white p-2 rounded-full hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 disabled:bg-indigo-400 dark:disabled:bg-indigo-800 disabled:cursor-not-allowed">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                                </button>
                            </div>
                        </form>
                    </div>
                </footer>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm mx-4">
            <h2 id="modal-title" class="text-lg font-bold text-gray-900 dark:text-white">Are you sure?</h2>
            <p id="modal-text" class="mt-2 text-sm text-gray-600 dark:text-gray-400">This action cannot be undone.</p>
            <div class="mt-6 flex justify-end gap-4">
                <button id="cancel-delete-btn" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none">Cancel</button>
                <button id="confirm-delete-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 focus:outline-none">Delete</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const authView = document.getElementById('auth-view');
            const chatView = document.getElementById('chat-view');
            const authForm = document.getElementById('auth-form');
            const authTitle = document.getElementById('auth-title');
            const authSubmitBtn = document.getElementById('auth-submit-btn');
            const authToggleLink = document.getElementById('auth-toggle-link');
            const authError = document.getElementById('auth-error');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const logoutBtn = document.getElementById('logout-btn');

            const chatForm = document.getElementById('chat-form');
            const submitButton = document.getElementById('submit-button');
            const chatHistory = document.getElementById('chat-history');
            const pdfFileInput = document.getElementById('pdf-file');
            const fileNameDisplay = document.getElementById('file-name');
            const questionInput = document.getElementById('question');
            const themeToggle = document.getElementById('theme-toggle');
            const themeIconLight = document.getElementById('theme-icon-light');
            const themeIconDark = document.getElementById('theme-icon-dark');
            const pdfUploadContainer = document.getElementById('pdf-upload-container');
            const newChatBtn = document.getElementById('new-chat-btn');
            const chatList = document.getElementById('chat-list');
            const chatTitle = document.getElementById('chat-title');
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            const confirmationModal = document.getElementById('confirmation-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalText = document.getElementById('modal-text');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const md = window.markdownit(); 

           const API_BASE_URL = 'https://pdf-chatbot-0cel.onrender.com';
            let currentChatId = null;
            let isLoginMode = true;
            let deleteTarget = { type: null, id: null };

            // --- AUTHENTICATION LOGIC ---
            function showAuthView() {
                authView.classList.remove('hidden');
                chatView.classList.add('hidden');
                localStorage.removeItem('userId');
            }

            function showChatView() {
                authView.classList.add('hidden');
                chatView.classList.remove('hidden');
                startNewChat();
            }

            authToggleLink.addEventListener('click', (e) => {
                e.preventDefault();
                isLoginMode = !isLoginMode;
                authTitle.textContent = isLoginMode ? 'Sign in to your account' : 'Create a new account';
                authSubmitBtn.textContent = isLoginMode ? 'Sign In' : 'Register';
                authToggleLink.textContent = isLoginMode ? "Don't have an account? Register" : "Already have an account? Sign In";
                authError.classList.add('hidden');
            });

            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = usernameInput.value;
                const password = passwordInput.value;
                const endpoint = isLoginMode ? '/api/login' : '/api/register';

                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || 'An unknown error occurred.');
                    }
                    localStorage.setItem('userId', data.user_id);
                    showChatView();
                } catch (error) {
                    authError.textContent = error.message;
                    authError.classList.remove('hidden');
                }
            });

            logoutBtn.addEventListener('click', showAuthView);

            // --- THEME LOGIC ---
            const updateThemeIcons = () => {
                if (document.documentElement.classList.contains('dark')) {
                    themeIconLight.classList.remove('hidden');
                    themeIconDark.classList.add('hidden');
                } else {
                    themeIconLight.classList.add('hidden');
                    themeIconDark.classList.remove('hidden');
                }
            };
            themeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
                updateThemeIcons();
            });
            updateThemeIcons();

            // --- CHAT MANAGEMENT ---
            async function loadChatList() {
                const userId = localStorage.getItem('userId');
                if (!userId) return;
                try {
                    const response = await fetch(`${API_BASE_URL}/api/chats?user_id=${userId}`);
                    if (!response.ok) throw new Error('Failed to load chat list.');
                    const sessions = await response.json();
                    chatList.innerHTML = '';
                    sessions.forEach(session => {
                        const sessionContainer = document.createElement('div');
                        sessionContainer.className = 'relative group';

                        const sessionButton = document.createElement('button');
                        sessionButton.className = `w-full text-left pl-4 pr-10 py-2 text-sm rounded-md ${currentChatId === session.id ? 'bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}`;
                        sessionButton.textContent = session.title;
                        sessionButton.dataset.chatId = session.id;
                        sessionButton.onclick = () => loadChatSession(session.id);

                        const deleteButton = document.createElement('button');
                        deleteButton.className = 'absolute right-2 top-1/2 -translate-y-1/2 p-1 text-gray-400 hover:text-red-500 rounded-full opacity-0 group-hover:opacity-100 transition-opacity';
                        deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`;
                        deleteButton.onclick = (e) => {
                            e.stopPropagation();
                            promptForDelete('single', session.id);
                        };
                        
                        sessionContainer.appendChild(sessionButton);
                        sessionContainer.appendChild(deleteButton);
                        chatList.appendChild(sessionContainer);
                    });
                } catch (error) {
                    console.error("Error loading chat list:", error);
                }
            }

            async function loadChatSession(chatId) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/chat/${chatId}`);
                    if (!response.ok) throw new Error('Failed to load chat session.');
                    const session = await response.json();
                    currentChatId = session._id;
                    chatTitle.textContent = session.title;
                    chatHistory.innerHTML = '';
                    session.history.forEach(turn => {
                        appendUserMessage(turn.user);
                        appendBotMessage(md.render(turn.bot_markdown));
                    });
                    pdfUploadContainer.classList.add('hidden'); 
                    loadChatList();
                } catch (error) {
                    console.error("Error loading chat session:", error);
                    appendErrorMessage("Could not load the selected chat.");
                }
            }

            function startNewChat() {
                currentChatId = null;
                chatTitle.textContent = 'New Chat';
                chatHistory.innerHTML = '';
                pdfFileInput.value = '';
                fileNameDisplay.textContent = 'Click or drag & drop a PDF file';
                pdfUploadContainer.classList.remove('hidden');
                loadChatList();
            }
            newChatBtn.addEventListener('click', startNewChat);

            // --- CLEAR HISTORY MODAL LOGIC ---
            function promptForDelete(type, id = null) {
                deleteTarget = { type, id };
                if (type === 'all') {
                    modalTitle.textContent = 'Clear All History?';
                    modalText.textContent = 'This will permanently delete all your saved chat conversations. This action cannot be undone.';
                } else {
                    modalTitle.textContent = 'Delete Chat?';
                    modalText.textContent = 'This will permanently delete this chat session. This action cannot be undone.';
                }
                confirmationModal.classList.remove('hidden');
            }

            clearHistoryBtn.addEventListener('click', () => promptForDelete('all'));
            cancelDeleteBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));
            confirmDeleteBtn.addEventListener('click', async () => {
                const { type, id } = deleteTarget;
                const userId = localStorage.getItem('userId');
                if (!userId) return;

                const url = type === 'all' ? `${API_BASE_URL}/api/chats?user_id=${userId}` : `${API_BASE_URL}/api/chat/${id}`;
                
                try {
                    const response = await fetch(url, { method: 'DELETE' });
                    if (!response.ok) throw new Error(`Failed to delete on server.`);
                    
                    if (type === 'all' || id === currentChatId) {
                        startNewChat();
                    } else {
                        loadChatList();
                    }
                } catch (error) {
                    console.error("Error deleting:", error);
                    appendErrorMessage("Could not complete deletion.");
                } finally {
                    confirmationModal.classList.add('hidden');
                }
            });

            // --- FORM & UI LOGIC ---
            pdfFileInput.addEventListener('change', () => {
                if (pdfFileInput.files.length > 0) {
                    fileNameDisplay.textContent = pdfFileInput.files[0].name;
                }
            });
            
            pdfUploadContainer.addEventListener('dragover', (e) => { e.preventDefault(); pdfUploadContainer.classList.add('border-indigo-500'); });
            pdfUploadContainer.addEventListener('dragleave', (e) => { e.preventDefault(); pdfUploadContainer.classList.remove('border-indigo-500'); });
            pdfUploadContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                pdfUploadContainer.classList.remove('border-indigo-500');
                if (e.dataTransfer.files.length > 0 && e.dataTransfer.files[0].type === "application/pdf") {
                    pdfFileInput.files = e.dataTransfer.files;
                    pdfFileInput.dispatchEvent(new Event('change'));
                }
            });

            // --- MAIN FORM SUBMISSION ---
            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(chatForm);
                const question = formData.get('question').trim();
                const userId = localStorage.getItem('userId');

                if (!question || !userId) return;
                if (!currentChatId && (!pdfFileInput.files || pdfFileInput.files.length === 0)) {
                    appendErrorMessage('Please upload a PDF to start a new chat.');
                    return;
                }

                submitButton.disabled = true;
                questionInput.value = '';
                appendUserMessage(question);
                
                let botMessageElement;
                if (!currentChatId) {
                    botMessageElement = appendBotMessageContainer("Analyzing your PDF, this may take a moment...");
                } else {
                    botMessageElement = appendBotMessageContainer();
                }
                
                let fullResponseMarkdown = '';
                let isFirstChunk = true;
                
                formData.append('user_id', userId);
                formData.append('chat_id', currentChatId);

                try {
                    const response = await fetch(`${API_BASE_URL}/api/chat`, { method: 'POST', body: formData });
                    if (!response.ok || !response.body) throw new Error('Network response was not ok.');
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data:')) {
                                const dataStr = line.substring(5).trim();
                                if (dataStr) {
                                    const data = JSON.parse(dataStr);
                                    if (data.text) {
                                        if (isFirstChunk) {
                                            fullResponseMarkdown = data.text;
                                            isFirstChunk = false;
                                        } else {
                                            fullResponseMarkdown += data.text;
                                        }
                                        botMessageElement.innerHTML = md.render(fullResponseMarkdown);
                                        scrollToBottom();
                                    } else if (data.error) {
                                        throw new Error(data.error);
                                    } else if (data.end_of_stream) {
                                        if (!currentChatId) { 
                                            currentChatId = data.chat_id;
                                            chatTitle.textContent = question.substring(0, 30) + "...";
                                            pdfUploadContainer.classList.add('hidden');
                                        }
                                        loadChatList(); 
                                    }
                                }
                            }
                        }
                    }
                } catch (error) {
                    botMessageElement.innerHTML = `<p class="text-red-500"><strong>Error:</strong> ${error.message}</p>`;
                } finally {
                    submitButton.disabled = false;
                }
            });

            // --- HTML APPENDING FUNCTIONS ---
            function appendUserMessage(message) {
                const messageHtml = `<div class="flex items-start gap-3 justify-end"><div class="bg-blue-500 p-4 rounded-lg shadow-sm chat-bubble"><p class="text-white">${message}</p></div><div class="bg-blue-500 text-white p-2 rounded-full flex-shrink-0 shadow-md"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div></div>`;
                chatHistory.insertAdjacentHTML('beforeend', messageHtml);
                scrollToBottom();
            }

            function appendBotMessageContainer(initialText = null) {
                const messageId = `bot-${Date.now()}`;
                const buttonId = `copy-btn-${Date.now()}`;
                let contentHtml;
                if (initialText) {
                    contentHtml = `<p class="text-gray-500 dark:text-gray-400 italic">${initialText}</p>`;
                } else {
                    contentHtml = `<div class="flex items-center"><div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: -0.3s;"></div><div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce mx-1" style="animation-delay: -0.15s;"></div><div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div></div>`;
                }
                const messageHtml = `<div class="flex items-start gap-3"><div class="bg-indigo-600 text-white p-2 rounded-full flex-shrink-0 shadow-md"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg></div><div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm chat-bubble relative group"><div id="${messageId}" class="prose-styles">${contentHtml}</div><button id="${buttonId}" class="absolute top-2 right-2 bg-gray-200 dark:bg-gray-700 p-1 rounded-md opacity-0 group-hover:opacity-100 transition-opacity" title="Copy text"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg></button></div></div>`;
                chatHistory.insertAdjacentHTML('beforeend', messageHtml);
                const botMessageElement = document.getElementById(messageId);
                
                document.getElementById(buttonId).addEventListener('click', function() {
                    copyToClipboard(this, messageId);
                });
                scrollToBottom();
                return botMessageElement;
            }
            
            function appendErrorMessage(message) {
                 const errorHtml = `<div class="flex items-start gap-3"><div class="bg-red-500/20 text-red-700 dark:text-red-400 p-2 rounded-full flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg></div><div class="bg-red-100 dark:bg-red-900/30 p-4 rounded-lg shadow-sm chat-bubble"><p class="font-medium text-red-800 dark:text-red-300">${message}</p></div></div>`;
                chatHistory.insertAdjacentHTML('beforeend', errorHtml);
                scrollToBottom();
            }

            function appendBotMessage(htmlContent) {
                const messageId = `bot-${Date.now()}`;
                const buttonId = `copy-btn-${Date.now()}`;
                const messageHtml = `<div class="flex items-start gap-3"><div class="bg-indigo-600 text-white p-2 rounded-full flex-shrink-0 shadow-md"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg></div><div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm chat-bubble relative group"><div id="${messageId}" class="prose-styles">${htmlContent}</div><button id="${buttonId}" class="absolute top-2 right-2 bg-gray-200 dark:bg-gray-700 p-1 rounded-md opacity-0 group-hover:opacity-100 transition-opacity" title="Copy text"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg></button></div></div>`;
                chatHistory.insertAdjacentHTML('beforeend', messageHtml);
                document.getElementById(buttonId).addEventListener('click', function() {
                    copyToClipboard(this, messageId);
                });
                scrollToBottom();
            }
            
            function copyToClipboard(button, elementId) {
                const element = document.getElementById(elementId);
                navigator.clipboard.writeText(element.innerText).then(() => {
                    const originalIcon = button.innerHTML;
                    button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><path d="M20 6 9 17l-5-5"/></svg>`;
                    setTimeout(() => { button.innerHTML = originalIcon; }, 2000);
                });
            }

            function scrollToBottom() {
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }

            // --- INITIALIZE APP ---
            if (localStorage.getItem('userId')) {
                showChatView();
            } else {
                showAuthView();
            }
        });
    </script>
</body>
</html>
